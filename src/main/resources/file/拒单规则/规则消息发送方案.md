åœ¨Droolsä¸MQé›†æˆä¸­ï¼Œç¡®ä¿æ¶ˆæ¯å¯é ä¼ é€’è‡³å…³é‡è¦ã€‚ä¸‹é¢æˆ‘ä¸ºæ‚¨æä¾›ä¸€ä¸ªè¯¦ç»†çš„æ–¹æ¡ˆè®¾è®¡å’Œä»£ç å®ç°ï¼Œé‡ç‚¹æ¶µç›–æ‰‹åŠ¨ç¡®è®¤æœºåˆ¶ã€é‡è¯•ä¸æ­»ä¿¡é˜Ÿåˆ—ã€ä»¥åŠæ¶ˆè´¹å¹‚ç­‰æ€§çš„å®ç°ã€‚

## ğŸ”§ æ•´ä½“æ¶æ„è®¾è®¡

åœ¨æ·±å…¥ä»£ç å‰ï¼Œå…ˆé€šè¿‡ä¸‹é¢çš„åºåˆ—å›¾äº†è§£æ¶ˆæ¯å¤„ç†çš„å®Œæ•´æµç¨‹ï¼Œç‰¹åˆ«æ˜¯æ­£å¸¸å¤„ç†ã€é‡è¯•åŠæ­»ä¿¡å¤„ç†çš„è·¯å¾„ï¼š

```
sequenceDiagram
    participant P as ç”Ÿäº§è€…
    participant Q as RabbitMQ
    participant C as æ¶ˆè´¹è€…
    participant DLQ as æ­»ä¿¡é˜Ÿåˆ—
    participant Redis as Redis

    P->>Q: 1. å‘é€è§„åˆ™æ›´æ–°æ¶ˆæ¯
    Q->>P: 2. è¿”å›ACKç¡®è®¤
    Q->>C: 3. æŠ•é€’æ¶ˆæ¯
    C->>Redis: 4. æ£€æŸ¥å¹‚ç­‰æ€§
    alt æ¶ˆæ¯å·²å¤„ç†
        C->>Q: 4.1 ç›´æ¥ACK
    else æ¶ˆæ¯æœªå¤„ç†
        C->>C: 5. å¤„ç†ä¸šåŠ¡é€»è¾‘
        alt å¤„ç†æˆåŠŸ
            C->>Redis: 5.1 è®°å½•å·²å¤„ç†
            C->>Q: 5.2 æ‰‹åŠ¨ACK
        else å¤„ç†å¤±è´¥
            C->>Q: 5.3 å‘é€NACK(requeue=true)
            Q->>C: 5.4 é‡æ–°æŠ•é€’
            Note over C: é‡å¤æ­¥éª¤4-5<br/>æœ€å¤šé‡è¯•3æ¬¡
            alt è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°
                C->>Q: 5.5 å‘é€NACK(requeue=false)
                Q->>DLQ: 5.6 è½¬å…¥æ­»ä¿¡é˜Ÿåˆ—
            end
        end
    end
```

## ğŸ’¾ æ¶ˆæ¯è¡¨ç»“æ„è®¾è®¡

é¦–å…ˆéœ€è¦åˆ›å»ºæ¶ˆæ¯æ—¥å¿—è¡¨æ¥è·Ÿè¸ªæ¶ˆæ¯çŠ¶æ€ï¼š

```
CREATE TABLE mail_send_log (
    msg_id VARCHAR(64) PRIMARY KEY COMMENT 'æ¶ˆæ¯å”¯ä¸€ID',
    rule_version VARCHAR(50) COMMENT 'è§„åˆ™ç‰ˆæœ¬å·',
    status TINYINT DEFAULT 0 COMMENT '0:æŠ•é€’ä¸­;1:æŠ•é€’æˆåŠŸ;2:æŠ•é€’å¤±è´¥',
    count TINYINT DEFAULT 0 COMMENT 'é‡è¯•æ¬¡æ•°',
    try_time DATETIME COMMENT 'ä¸‹æ¬¡é‡è¯•æ—¶é—´',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

## ğŸ“¦ ç”Ÿäº§è€…ç«¯å®ç°

### 1. é…ç½®ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶

```
# application.yml
spring:
  rabbitmq:
    host: localhost
    port: 5672
    username: guest
    password: guest
    publisher-confirm-type: correlated    # ç”Ÿäº§è€…ç¡®è®¤
    publisher-returns: true               # å¼€å¯è¿”å›æœºåˆ¶
```

### 2. RabbitMQé…ç½®ç±»

```
@Configuration
@Slf4j
public class RabbitConfig {
    
    @Autowired
    private CachingConnectionFactory cachingConnectionFactory;
    
    @Autowired
    private MessageLogService messageLogService;
    
    @Bean
    public RabbitTemplate rabbitTemplate() {
        RabbitTemplate rabbitTemplate = new RabbitTemplate(cachingConnectionFactory);
        
        // æ¶ˆæ¯å‘é€åˆ°Brokerçš„å›è°ƒ
        rabbitTemplate.setConfirmCallback(new RabbitTemplate.ConfirmCallback() {
            @Override
            public void confirm(CorrelationData correlationData, boolean ack, String cause) {
                String msgId = correlationData.getId();
                if (ack) {
                    messageLogService.updateStatus(msgId, 1); // æ›´æ–°çŠ¶æ€ä¸ºæˆåŠŸ
                    log.info("æ¶ˆæ¯ {} å‘é€æˆåŠŸ", msgId);
                } else {
                    log.error("æ¶ˆæ¯ {} å‘é€å¤±è´¥ï¼ŒåŸå› : {}", msgId, cause);
                }
            }
        });
        
        // æ¶ˆæ¯ä»Exchangeè·¯ç”±åˆ°Queueå¤±è´¥çš„å›è°ƒ
        rabbitTemplate.setReturnCallback((message, replyCode, replyText, exchange, routingKey) -> {
            log.error("æ¶ˆæ¯è·¯ç”±å¤±è´¥ï¼Œåº”ç­”ç :{}ï¼ŒåŸå› :{}ï¼Œäº¤æ¢æœº:{}ï¼Œè·¯ç”±é”®:{}ï¼Œæ¶ˆæ¯:{}", 
                     replyCode, replyText, exchange, routingKey, message.toString());
        });
        
        return rabbitTemplate;
    }
    
    // å£°æ˜è§„åˆ™æ›´æ–°é˜Ÿåˆ—
    @Bean
    public Queue ruleUpdateQueue() {
        Map<String, Object> args = new HashMap<>();
        args.put("x-dead-letter-exchange", "rule.dlx.exchange");    // æ­»ä¿¡äº¤æ¢æœº
        args.put("x-dead-letter-routing-key", "rule.dlx.routingkey"); // æ­»ä¿¡è·¯ç”±é”®
        args.put("x-message-ttl", 10000); // æ¶ˆæ¯TTL 10ç§’
        return new Queue("rule.update.queue", true, false, false, args);
    }
    
    // å£°æ˜æ­»ä¿¡é˜Ÿåˆ—
    @Bean
    public Queue ruleDlq() {
        return new Queue("rule.dlq", true);
    }
    
    @Bean
    public DirectExchange ruleExchange() {
        return new DirectExchange("rule.exchange", true, false);
    }
    
    @Bean
    public DirectExchange ruleDlxExchange() {
        return new DirectExchange("rule.dlx.exchange", true, false);
    }
    
    @Bean
    public Binding ruleBinding() {
        return BindingBuilder.bind(ruleUpdateQueue()).to(ruleExchange()).with("rule.update");
    }
    
    @Bean
    public Binding ruleDlxBinding() {
        return BindingBuilder.bind(ruleDlq()).to(ruleDlxExchange()).with("rule.dlx.routingkey");
    }
}
```

### 3. æ¶ˆæ¯å‘é€æœåŠ¡

```
@Service
@Slf4j
public class RuleUpdateProducer {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @Autowired
    private MessageLogService messageLogService;
    
    public void sendRuleUpdateMessage(RuleUpdateEvent ruleUpdateEvent) {
        String msgId = UUID.randomUUID().toString();
        
        // ä¿å­˜æ¶ˆæ¯åˆ°æ—¥å¿—è¡¨
        MessageLog messageLog = new MessageLog();
        messageLog.setMsgId(msgId);
        messageLog.setRuleVersion(ruleUpdateEvent.getRuleVersion());
        messageLog.setStatus(0); // æŠ•é€’ä¸­
        messageLog.setCount(0);  // é‡è¯•æ¬¡æ•°
        messageLog.setTryTime(new Date(System.currentTimeMillis() + 1000 * 60 * 1)); // 1åˆ†é’Ÿåé‡è¯•
        messageLogService.insert(messageLog);
        
        try {
            // å‘é€æ¶ˆæ¯
            rabbitTemplate.convertAndSend("rule.exchange", "rule.update", ruleUpdateEvent, 
                new CorrelationData(msgId));
            log.info("è§„åˆ™æ›´æ–°æ¶ˆæ¯å‘é€æˆåŠŸï¼Œæ¶ˆæ¯ID: {}", msgId);
        } catch (Exception e) {
            log.error("è§„åˆ™æ›´æ–°æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œæ¶ˆæ¯ID: {}", msgId, e);
        }
    }
}
```

### 4. æ¶ˆæ¯é‡è¯•ä»»åŠ¡

```
@Component
@Slf4j
public class MessageRetryTask {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @Autowired
    private MessageLogService messageLogService;
    
    @Scheduled(cron = "0/30 * * * * ?") // æ¯30ç§’æ‰§è¡Œä¸€æ¬¡
    public void messageRetry() {
        // æŸ¥è¯¢éœ€è¦é‡è¯•çš„æ¶ˆæ¯
        List<MessageLog> needRetryMessages = messageLogService.getNeedRetryMessages();
        
        needRetryMessages.forEach(message -> {
            if (message.getCount() >= 3) {
                // è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ ‡è®°ä¸ºå¤±è´¥
                messageLogService.updateStatus(message.getMsgId(), 2);
                log.warn("æ¶ˆæ¯ {} é‡è¯•æ¬¡æ•°å·²è¶…è¿‡3æ¬¡ï¼Œæ ‡è®°ä¸ºå¤±è´¥", message.getMsgId());
            } else {
                // æ‰§è¡Œé‡è¯•
                log.info("æ¶ˆæ¯ {} å¼€å§‹ç¬¬ {} æ¬¡é‡è¯•", message.getMsgId(), message.getCount() + 1);
                
                RuleUpdateEvent event = new RuleUpdateEvent();
                event.setRuleVersion(message.getRuleVersion());
                
                messageLogService.updateCount(message.getMsgId(), new Date());
                rabbitTemplate.convertAndSend("rule.exchange", "rule.update", event, 
                    new CorrelationData(message.getMsgId()));
            }
        });
    }
}
```

## ğŸ‘¨ğŸ’» æ¶ˆè´¹è€…ç«¯å®ç°

### 1. é…ç½®æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶

```
spring:
  rabbitmq:
    listener:
      simple:
        acknowledge-mode: manual  # æ‰‹åŠ¨ç¡®è®¤
        prefetch: 1               # æ¯æ¬¡é¢„å–1æ¡æ¶ˆæ¯
        retry:
          enabled: true           # å¼€å¯é‡è¯•
          max-attempts: 3        # æœ€å¤§é‡è¯•æ¬¡æ•°
          initial-interval: 2000ms # é‡è¯•é—´éš”
```

### 2. æ¶ˆè´¹è€…å®ç°ï¼ˆåŒ…å«å¹‚ç­‰æ€§å¤„ç†ï¼‰

```
@Component
@Slf4j
public class RuleUpdateConsumer {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    @Autowired
    private RuleEngineService ruleEngineService;
    
    @Autowired
    private MessageLogService messageLogService;
    
    private static final String MESSAGE_CACHE_KEY = "rule_update_message";
    
    @RabbitListener(queues = "rule.update.queue")
    public void handleRuleUpdate(Message message, Channel channel) throws IOException {
        Long deliveryTag = (Long) message.getHeaders().get(AmqpHeaders.DELIVERY_TAG);
        String msgId = message.getHeaders().get("spring_returned_message_correlation", String.class);
        
        if (msgId == null) {
            log.error("æ¶ˆæ¯IDä¸ºç©ºï¼Œæ‹’ç»æ¶ˆæ¯");
            channel.basicNack(deliveryTag, false, false);
            return;
        }
        
        try {
            // 1. å¹‚ç­‰æ€§æ£€æŸ¥ï¼šæ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å¤„ç†
            if (redisTemplate.opsForHash().hasKey(MESSAGE_CACHE_KEY, msgId)) {
                log.info("æ¶ˆæ¯ {} å·²å¤„ç†ï¼Œç›´æ¥ç¡®è®¤", msgId);
                channel.basicAck(deliveryTag, false);
                return;
            }
            
            // 2. è§£ææ¶ˆæ¯å†…å®¹
            RuleUpdateEvent ruleUpdateEvent = (RuleUpdateEvent) message.getPayload();
            String ruleVersion = ruleUpdateEvent.getRuleVersion();
            
            log.info("å¼€å§‹å¤„ç†è§„åˆ™æ›´æ–°æ¶ˆæ¯: {}, è§„åˆ™ç‰ˆæœ¬: {}", msgId, ruleVersion);
            
            // 3. ä»Redisè·å–æœ€æ–°è§„åˆ™æ–‡ä»¶
            String ruleContent = getRuleContentFromRedis(ruleVersion);
            if (ruleContent == null) {
                throw new RuntimeException("æœªæ‰¾åˆ°è§„åˆ™ç‰ˆæœ¬: " + ruleVersion);
            }
            
            // 4. åŠ¨æ€åŠ è½½è§„åˆ™åˆ°Droolså¼•æ“
            boolean success = ruleEngineService.loadRule(ruleContent);
            
            if (success) {
                // 5. å¤„ç†æˆåŠŸï¼Œè®°å½•å¹‚ç­‰æ€§
                redisTemplate.opsForHash().put(MESSAGE_CACHE_KEY, msgId, "processed");
                redisTemplate.expire(MESSAGE_CACHE_KEY, 24, TimeUnit.HOURS);
                
                // 6. æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯
                channel.basicAck(deliveryTag, false);
                log.info("è§„åˆ™æ›´æ–°æ¶ˆæ¯å¤„ç†æˆåŠŸ: {}", msgId);
                
            } else {
                throw new RuntimeException("è§„åˆ™åŠ è½½å¤±è´¥");
            }
            
        } catch (Exception e) {
            log.error("å¤„ç†è§„åˆ™æ›´æ–°æ¶ˆæ¯å¤±è´¥: {}", msgId, e);
            
            // æ£€æŸ¥é‡è¯•æ¬¡æ•°
            MessageLog messageLog = messageLogService.getMessageById(msgId);
            if (messageLog != null && messageLog.getCount() >= 2) { // å·²é‡è¯•2æ¬¡ï¼Œæ€»å…±3æ¬¡
                log.warn("æ¶ˆæ¯ {} å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œè½¬å…¥æ­»ä¿¡é˜Ÿåˆ—", msgId);
                
                // è®°å½•å¤±è´¥æ—¥å¿—
                redisTemplate.opsForHash().put(MESSAGE_CACHE_KEY + ":failed", msgId, e.getMessage());
                
                // æ‹’ç»æ¶ˆæ¯ï¼Œä¸é‡æ–°å…¥é˜Ÿ
                channel.basicNack(deliveryTag, false, false);
            } else {
                // é‡æ–°æ”¾å›é˜Ÿåˆ—é‡è¯•
                channel.basicNack(deliveryTag, false, true);
                log.info("æ¶ˆæ¯ {} é‡æ–°æ”¾å›é˜Ÿåˆ—ç­‰å¾…é‡è¯•", msgId);
            }
        }
    }
    
    private String getRuleContentFromRedis(String ruleVersion) {
        // ä»Redisè·å–è§„åˆ™å†…å®¹çš„å…·ä½“å®ç°
        return (String) redisTemplate.opsForHash().get("drools_rules", ruleVersion);
    }
}
```

### 3. Droolsè§„åˆ™å¼•æ“æœåŠ¡

```
@Service
@Slf4j
public class RuleEngineService {
    
    private KieContainer kieContainer;
    private KieSession kieSession;
    
    public synchronized boolean loadRule(String ruleContent) {
        try {
            KieServices kieServices = KieServices.Factory.get();
            KieFileSystem kfs = kieServices.newKieFileSystem();
            
            // å°†è§„åˆ™å†…å®¹å†™å…¥è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
            kfs.write("src/main/resources/rules/rule.drl", ruleContent);
            
            KieBuilder kieBuilder = kieServices.newKieBuilder(kfs).buildAll();
            Results results = kieBuilder.getResults();
            
            if (results.hasMessages(Message.Level.ERROR)) {
                log.error("è§„åˆ™ç¼–è¯‘é”™è¯¯: {}", results.getMessages());
                return false;
            }
            
            // é‡Šæ”¾æ—§çš„KieSession
            if (kieSession != null) {
                kieSession.dispose();
            }
            
            // åˆ›å»ºæ–°çš„KieContainerå’ŒKieSession
            KieRepository kieRepository = kieServices.getRepository();
            kieRepository.addKieModule(kieRepository::getDefaultReleaseId);
            
            kieContainer = kieServices.newKieContainer(kieRepository.getDefaultReleaseId());
            kieSession = kieContainer.newKieSession();
            
            log.info("è§„åˆ™å¼•æ“æ›´æ–°æˆåŠŸ");
            return true;
            
        } catch (Exception e) {
            log.error("è§„åˆ™å¼•æ“æ›´æ–°å¤±è´¥", e);
            return false;
        }
    }
    
    public void executeRules(Object fact) {
        if (kieSession != null) {
            try {
                kieSession.insert(fact);
                kieSession.fireAllRules();
            } catch (Exception e) {
                log.error("è§„åˆ™æ‰§è¡Œå¤±è´¥", e);
            }
        }
    }
}
```

## ğŸ›¡ï¸ æ­»ä¿¡é˜Ÿåˆ—å¤„ç†å™¨

```
@Component
@Slf4j
public class RuleDlqConsumer {
    
    @RabbitListener(queues = "rule.dlq")
    public void handleDeadLetterMessage(Message message, Channel channel) throws IOException {
        Long deliveryTag = (Long) message.getHeaders().get(AmqpHeaders.DELIVERY_TAG);
        String msgId = message.getHeaders().get("spring_returned_message_correlation", String.class);
        
        log.warn("æ”¶åˆ°æ­»ä¿¡æ¶ˆæ¯: {}", msgId);
        
        try {
            // è®°å½•æ­»ä¿¡æ¶ˆæ¯ï¼Œæ–¹ä¾¿äººå·¥å¹²é¢„
            // å¯ä»¥å‘é€å‘Šè­¦é‚®ä»¶ã€çŸ­ä¿¡ç­‰
            
            log.error("è§„åˆ™æ›´æ–°å¤±è´¥ï¼Œéœ€è¦äººå·¥å¹²é¢„ï¼Œæ¶ˆæ¯ID: {}", msgId);
            
            // ç¡®è®¤æ­»ä¿¡æ¶ˆæ¯
            channel.basicAck(deliveryTag, false);
            
        } catch (Exception e) {
            log.error("å¤„ç†æ­»ä¿¡æ¶ˆæ¯å¤±è´¥", e);
            channel.basicNack(deliveryTag, false, false);
        }
    }
}
```

## ğŸ’¡ å…³é”®è®¾è®¡è¦ç‚¹

### 1. å¹‚ç­‰æ€§ä¿éšœ

- â€¢

  ä½¿ç”¨Rediså­˜å‚¨å·²å¤„ç†æ¶ˆæ¯IDï¼Œé˜²æ­¢é‡å¤å¤„ç†

- â€¢

  æ¶ˆæ¯IDå…¨å±€å”¯ä¸€ï¼Œä½¿ç”¨UUIDç”Ÿæˆ

- â€¢

  è®¾ç½®åˆç†çš„ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆå¦‚24å°æ—¶ï¼‰

### 2. é‡è¯•ç­–ç•¥

- â€¢

  æœ€å¤§é‡è¯•æ¬¡æ•°ï¼š3æ¬¡

- â€¢

  é‡è¯•é—´éš”ï¼šæŒ‡æ•°é€€é¿ç­–ç•¥

- â€¢

  è¶…è¿‡é‡è¯•æ¬¡æ•°è½¬å…¥æ­»ä¿¡é˜Ÿåˆ—

### 3. é”™è¯¯å¤„ç†

- â€¢

  ç¼–è¯‘é”™è¯¯ï¼šç«‹å³å¤±è´¥ï¼Œä¸é‡è¯•

- â€¢

  ç½‘ç»œé”™è¯¯ï¼šè‡ªåŠ¨é‡è¯•

- â€¢

  ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼šæ ¹æ®å…·ä½“é”™è¯¯ç±»å‹å†³å®šæ˜¯å¦é‡è¯•

### 4. æ€§èƒ½ä¼˜åŒ–

- â€¢

  é¢„å–æ•°é‡è®¾ç½®ä¸º1ï¼Œç¡®ä¿å…¬å¹³åˆ†å‘

- â€¢

  Redisè¿æ¥æ± åˆç†é…ç½®

- â€¢

  è§„åˆ™ç¼–è¯‘ç»“æœç¼“å­˜ï¼Œé¿å…é‡å¤ç¼–è¯‘

è¿™ä¸ªæ–¹æ¡ˆç¡®ä¿äº†Droolsè§„åˆ™æ›´æ–°æ¶ˆæ¯çš„å¯é ä¼ é€’ï¼Œå³ä½¿åœ¨ç½‘ç»œæ•…éšœã€æœåŠ¡é‡å¯ç­‰å¼‚å¸¸æƒ…å†µä¸‹ä¹Ÿèƒ½ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚å®é™…åº”ç”¨ä¸­å¯ä»¥æ ¹æ®å…·ä½“ä¸šåŠ¡éœ€æ±‚è°ƒæ•´å‚æ•°å’Œç­–ç•¥ã€‚